<!DOCTYPE html>
<html ng-app="paymentApp">

<head>
    <title>Danh sách Thanh Toán</title>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
</head>

<body ng-controller="PaymentController">

    <h1>Danh sách Thanh Toán</h1>
    <!-- Tìm kiếm -->
    <label for="search">Tìm kiếm:</label>
    <input type="text" ng-model="searchQuery" placeholder="Nhập để tìm kiếm" ng-change="filterPayments()">

    <!-- Sắp xếp -->
    <label for="sort">Sắp xếp:</label>
    <select ng-model="sortOption" ng-change="filterPayments()">
        <option value="priceAmount">Giá</option>
        <option value="paymentStatus">Trạng thái</option>
        <option value="paymentDate">Ngày</option>
    </select>
    <select ng-model="sortDirection" ng-change="filterPayments()">
        <option value="asc">Tăng dần</option>
        <option value="desc">Giảm dần</option>
    </select>

    
    <tbody>
        <tr ng-repeat="payment in payments | orderBy:sortColumn:reverseOrder">

            <!-- Danh sách thanh toán -->
            <table border="1">
                <thead>
                    <tr>
                        <th>Payment ID</th>
                        <th>Post Name</th>
                        <th>Price Amount</th>
                        <th>Payment Amount</th>
                        <th>Currency</th>
                        <th>Bank Code</th>
                        <th>Payment Date</th>
                        <th>Top Post End</th>
                        <th>Payment Status</th>
                        <th>VNP Transaction ID</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr ng-repeat="payment in payments">
                        <td>{{payment.paymentId}}</td>
                        <td>{{payment.postName}}</td>
                        <td>{{payment.priceAmount}}</td>
                        <td>{{payment.paymentAmount}}</td>
                        <td>{{payment.currency}}</td>
                        <td>{{payment.bankCode}}</td>
                        <td>{{payment.paymentDate | date:'yyyy-MM-dd HH:mm'}}</td>
                        <td>{{payment.topPostEnd | date:'yyyy-MM-dd HH:mm'}}</td>
                        <td>{{payment.paymentStatus}}</td>
                        <td>{{payment.vnpTransactionId}}</td>
                        <td>
                            <button ng-click="loadPaymentDetails(payment.paymentId); openModal()">Xem Chi
                                Tiết</button>

                            <button ng-click="updatePaymentStatus(payment.paymentId, 'Completed')">Cập Nhật Trạng
                                Thái</button>
                        </td>
                    </tr>
                </tbody>
            </table>
            <!-- Tạo mới thanh toán -->
            <h2>Tạo Mới Thanh Toán</h2>
            <form ng-submit="createPayment()">
                <label for="postId">Post ID:</label>
                <input type="number" ng-model="newPayment.postId" required><br>
                <label for="priceId">Price ID:</label>
                <input type="number" ng-model="newPayment.priceId" required><br>
                <label for="priceAmount">Price Amount:</label>
                <input type="number" ng-model="newPayment.priceAmount" required><br>
                <label for="paymentAmount">Payment Amount:</label>
                <input type="number" ng-model="newPayment.paymentAmount" required><br>
                <label for="currency">Currency:</label>
                <input type="text" ng-model="newPayment.currency" required><br>
                <label for="paymentDate">Payment Date:</label>
                <input type="datetime-local" ng-model="newPayment.paymentDate" required><br>
                <label for="topPostEnd">Top Post End:</label>
                <input type="datetime-local" ng-model="newPayment.topPostEnd" required><br>
                <label for="paymentStatus">Payment Status:</label>
                <input type="text" ng-model="newPayment.paymentStatus" required><br>
                <label for="vnpTransactionId">VNP Transaction ID:</label>
                <input type="text" ng-model="newPayment.vnpTransactionId"><br>
                <button type="submit">Tạo Thanh Toán</button>
            </form>

           <!-- Phân trang -->
    <button ng-disabled="currentPage === 1" ng-click="prevPage()">Trang trước</button>
    <span>Trang {{currentPage}}/{{totalPages}}</span>
    <button ng-disabled="currentPage === totalPages" ng-click="nextPage()">Trang sau</button>


    <tbody>
        <tr ng-repeat="payment in payments | limitTo:pageSize:(currentPage-1)*pageSize">

            <script>
                angular.module('paymentApp', [])
                    .controller('PaymentController', function ($scope, $http) {
                        const apiBaseUrl = 'http://localhost:8080/api/admin/payments';
                        const token = localStorage.getItem("token");
                        $scope.payments = [];
                        $scope.selectedPayment = null;
                        $scope.newPayment = {};

                        // Lấy danh sách thanh toán
                        $scope.loadPayments = function () {
                            $http.get(apiBaseUrl + '/all', {
                                headers: { 'Authorization': `Bearer ${token}` }
                            })
                                .then(function (response) {
                                    $scope.payments = response.data;
                                }, function (error) {
                                    console.error("Error loading payments: ", error);
                                });
                        };

                        // Lấy chi tiết thanh toán
                        $scope.loadPaymentDetails = function (paymentId) {
                            $http.get(apiBaseUrl + '/' + paymentId, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            })
                                .then(function (response) {
                                    $scope.selectedPayment = response.data;
                                }, function (error) {
                                    console.error("Error loading payment details: ", error);
                                });
                        };

                        // Cập nhật trạng thái thanh toán
                        $scope.updatePaymentStatus = function (paymentId, status) {
                            $http.put(apiBaseUrl + '/' + paymentId + '/status', null, { params: { status: status }, headers: { 'Authorization': `Bearer ${token}` } })
                                .then(function (response) {
                                    $scope.loadPayments();
                                    alert("Payment status updated successfully!");
                                }, function (error) {
                                    console.error("Error updating payment status: ", error);
                                });
                        };

                        // Tạo mới thanh toán
                        $scope.createPayment = function () {
                            $http.post(apiBaseUrl + '/create', $scope.newPayment, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            })
                                .then(function (response) {
                                    alert("Payment created successfully!");
                                    $scope.loadPayments();
                                }, function (error) {
                                    console.error("Error creating payment: ", error);
                                });
                        };
                        // Khởi tạo
                        $scope.loadPayments();
                    });
                $scope.sortColumn = 'paymentId'; // Cột mặc định
                $scope.reverseOrder = false;

                $scope.sortBy = function (column) {
                    if ($scope.sortColumn === column) {
                        $scope.reverseOrder = !$scope.reverseOrder; // Đảo ngược thứ tự
                    } else {
                        $scope.sortColumn = column;
                        $scope.reverseOrder = false; // Mặc định là tăng dần
                    }
                };
                $scope.pageSize = 5; // Số bản ghi trên mỗi trang
                $scope.currentPage = 1;

                $scope.previousPage = function () {
                    if ($scope.currentPage > 1) {
                        $scope.currentPage--;
                    }
                };

                $scope.nextPage = function () {
                    if ($scope.currentPage < $scope.totalPages) {
                        $scope.currentPage++;
                    }
                };

                // Tính tổng số trang
                $scope.$watch('payments', function (newVal) {
                    if (newVal) {
                        $scope.totalPages = Math.ceil($scope.payments.length / $scope.pageSize);
                    }
                });

            </script>
</body>

</html>